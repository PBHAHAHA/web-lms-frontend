# ç¬¬å…«ç« ï¼šçŠ¶æ€ç®¡ç†ä¸æ•°æ®æµ

"ç®€å•æ˜¯å¤æ‚çš„ç»ˆæå½¢å¼ã€‚" â€”â€” åˆ—å¥¥çº³å¤šÂ·è¾¾Â·èŠ¬å¥‡

åœ¨ç°ä»£å‰ç«¯åº”ç”¨ä¸­ï¼ŒçŠ¶æ€ç®¡ç†å°±åƒæ˜¯ä¸€ä¸ªåŸå¸‚çš„äº¤é€šç³»ç»Ÿã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰çº¢ç»¿ç¯ã€äº¤é€šæ ‡å¿—å’Œç»Ÿä¸€çš„äº¤é€šè§„åˆ™ï¼ŒåŸå¸‚çš„äº¤é€šå°†ä¼šæ˜¯ä¸€ç‰‡æ··ä¹±ã€‚åŒæ ·ï¼Œå¦‚æœæ²¡æœ‰è‰¯å¥½çš„çŠ¶æ€ç®¡ç†ï¼Œåº”ç”¨çš„æ•°æ®æµå°†å˜å¾—éš¾ä»¥è¿½è¸ªå’Œç»´æŠ¤ã€‚

éšç€åº”ç”¨å¤æ‚åº¦çš„å¢åŠ ï¼Œç»„ä»¶é—´çš„æ•°æ®å…±äº«ã€çŠ¶æ€åŒæ­¥ã€å‰¯ä½œç”¨å¤„ç†ç­‰é—®é¢˜å˜å¾—è¶Šæ¥è¶Šçªå‡ºã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ—¢å¼ºå¤§åˆç®€æ´çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼Œæ—¢èƒ½å¤„ç†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œåˆèƒ½ä¿æŒä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

Pinia ä½œä¸º Vue 3 çš„å®˜æ–¹çŠ¶æ€ç®¡ç†åº“ï¼Œæä¾›äº†ç›´è§‚çš„ APIã€ä¼˜ç§€çš„ TypeScript æ”¯æŒå’Œå¼ºå¤§çš„å¼€å‘å·¥å…·ã€‚å®ƒä¸ä»…ç»§æ‰¿äº† Vuex çš„ä¼˜ç‚¹ï¼Œè¿˜è§£å†³äº†è®¸å¤šå†å²é—ç•™é—®é¢˜ï¼Œè®©çŠ¶æ€ç®¡ç†å˜å¾—æ›´åŠ ç®€å•å’Œé«˜æ•ˆã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢ç´¢ Pinia çš„é«˜çº§ç”¨æ³•ï¼Œå­¦ä¹ å¦‚ä½•æ„å»ºå¯æ‰©å±•ã€å¯ç»´æŠ¤çš„çŠ¶æ€ç®¡ç†æ¶æ„ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°é«˜çº§æ¨¡å¼ï¼Œä»å•ä¸€ Store åˆ°å¤æ‚çš„çŠ¶æ€ç”Ÿæ€ç³»ç»Ÿã€‚

## ğŸ¯ æœ¬ç« ç›®æ ‡

- æŒæ¡ Pinia çš„é«˜çº§ç”¨æ³•å’Œæœ€ä½³å®è·µ
- è®¾è®¡æ¨¡å—åŒ–çš„çŠ¶æ€ç®¡ç†æ¶æ„
- å®ç°çŠ¶æ€æŒä¹…åŒ–å’ŒåŒæ­¥æœºåˆ¶
- æ„å»ºå“åº”å¼çš„æ•°æ®æµç³»ç»Ÿ
- ä¼˜åŒ–çŠ¶æ€ç®¡ç†çš„æ€§èƒ½å’Œå¼€å‘ä½“éªŒ

## ğŸ—ï¸ çŠ¶æ€ç®¡ç†æ¶æ„è®¾è®¡

### æ ¸å¿ƒæ¦‚å¿µä¸è®¾è®¡åŸåˆ™

åœ¨è®¾è®¡çŠ¶æ€ç®¡ç†æ¶æ„æ—¶ï¼Œæˆ‘ä»¬éœ€è¦éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **å•ä¸€æ•°æ®æº**ï¼šæ¯ä¸ªçŠ¶æ€éƒ½æœ‰å”¯ä¸€çš„æ¥æº
2. **çŠ¶æ€ä¸å¯å˜**ï¼šé€šè¿‡ actions ä¿®æ”¹çŠ¶æ€
3. **å¯é¢„æµ‹æ€§**ï¼šçŠ¶æ€å˜åŒ–å¯è¿½è¸ªå’Œè°ƒè¯•
4. **æ¨¡å—åŒ–**ï¼šæŒ‰åŠŸèƒ½åŸŸåˆ’åˆ† Store
5. **ç±»å‹å®‰å…¨**ï¼šå……åˆ†åˆ©ç”¨ TypeScript

```typescript
// stores/index.ts
import { createPinia } from 'pinia'
import { createPersistedState } from 'pinia-plugin-persistedstate'

// åˆ›å»º Pinia å®ä¾‹
export const pinia = createPinia()

// æ·»åŠ æŒä¹…åŒ–æ’ä»¶
pinia.use(createPersistedState({
  storage: localStorage,
  serializer: {
    serialize: JSON.stringify,
    deserialize: JSON.parse,
  },
}))

// Store ç±»å‹å®šä¹‰
export interface StoreState {
  // ç”¨æˆ·ç›¸å…³çŠ¶æ€
  user: {
    profile: User | null
    preferences: UserPreferences
    permissions: Permission[]
  }
  
  // åº”ç”¨ç›¸å…³çŠ¶æ€
  app: {
    theme: 'light' | 'dark' | 'system'
    language: string
    sidebar: {
      collapsed: boolean
      width: number
    }
    notifications: Notification[]
  }
  
  // è¯¾ç¨‹ç›¸å…³çŠ¶æ€
  course: {
    courses: Course[]
    currentCourse: Course | null
    enrollments: Enrollment[]
    progress: Record<string, Progress>
  }
  
  // å­¦ä¹ ç›¸å…³çŠ¶æ€
  learning: {
    currentLesson: Lesson | null
    playbackState: PlaybackState
    notes: Note[]
    bookmarks: Bookmark[]
  }
}

// å…¨å±€çŠ¶æ€ç±»å‹
export type RootState = StoreState
```

### åŸºç¡€ Store æŠ½è±¡

```typescript
// stores/base.ts
import { defineStore } from 'pinia'
import type { Ref } from 'vue'

// åŸºç¡€çŠ¶æ€æ¥å£
export interface BaseState {
  loading: boolean
  error: string | null
  lastUpdated: number | null
}

// åŸºç¡€ Store é…ç½®
export interface BaseStoreOptions<T extends BaseState> {
  id: string
  initialState: () => T
  persist?: boolean | {
    key?: string
    storage?: Storage
    paths?: string[]
  }
}

// åˆ›å»ºåŸºç¡€ Store
export function createBaseStore<T extends BaseState>(
  options: BaseStoreOptions<T>
) {
  return defineStore(options.id, {
    state: () => ({
      ...options.initialState(),
      loading: false,
      error: null,
      lastUpdated: null,
    } as T),

    getters: {
      // æ˜¯å¦æœ‰é”™è¯¯
      hasError: (state) => !!state.error,
      
      // æ˜¯å¦æ­£åœ¨åŠ è½½
      isLoading: (state) => state.loading,
      
      // æ•°æ®æ˜¯å¦è¿‡æœŸï¼ˆ5åˆ†é’Ÿï¼‰
      isStale: (state) => {
        if (!state.lastUpdated) return true
        return Date.now() - state.lastUpdated > 5 * 60 * 1000
      },
    },

    actions: {
      // è®¾ç½®åŠ è½½çŠ¶æ€
      setLoading(loading: boolean) {
        this.loading = loading
      },

      // è®¾ç½®é”™è¯¯
      setError(error: string | null) {
        this.error = error
      },

      // æ¸…é™¤é”™è¯¯
      clearError() {
        this.error = null
      },

      // æ›´æ–°æ—¶é—´æˆ³
      updateTimestamp() {
        this.lastUpdated = Date.now()
      },

      // é‡ç½®çŠ¶æ€
      $reset() {
        Object.assign(this, options.initialState())
        this.loading = false
        this.error = null
        this.lastUpdated = null
      },
    },

    persist: options.persist,
  })
}

// å¼‚æ­¥æ“ä½œåŒ…è£…å™¨
export function withAsyncState<T>(
  store: any,
  asyncFn: () => Promise<T>
): Promise<{ data: T | null; error: string | null }> {
  return new Promise(async (resolve) => {
    store.setLoading(true)
    store.clearError()

    try {
      const data = await asyncFn()
      store.updateTimestamp()
      resolve({ data, error: null })
    } catch (error: any) {
      const errorMessage = error.message || 'æ“ä½œå¤±è´¥'
      store.setError(errorMessage)
      resolve({ data: null, error: errorMessage })
    } finally {
      store.setLoading(false)
    }
  })
}
```

## ğŸ” ç”¨æˆ·çŠ¶æ€ç®¡ç†

### ç”¨æˆ· Store

```typescript
// stores/user.ts
import { defineStore } from 'pinia'
import type { User, UserPreferences, Permission } from '~/types/user'
import { createBaseStore, withAsyncState } from './base'

interface UserState extends BaseState {
  profile: User | null
  preferences: UserPreferences
  permissions: Permission[]
  isAuthenticated: boolean
  token: string | null
  refreshToken: string | null
}

export const useUserStore = defineStore('user', {
  state: (): UserState => ({
    profile: null,
    preferences: {
      theme: 'system',
      language: 'zh-CN',
      notifications: {
        email: true,
        push: true,
        sms: false,
      },
      privacy: {
        profileVisible: true,
        progressVisible: true,
      },
    },
    permissions: [],
    isAuthenticated: false,
    token: null,
    refreshToken: null,
    loading: false,
    error: null,
    lastUpdated: null,
  }),

  getters: {
    // ç”¨æˆ·å…¨å
    fullName: (state) => {
      if (!state.profile) return ''
      return `${state.profile.firstName} ${state.profile.lastName}`.trim()
    },

    // ç”¨æˆ·å¤´åƒ
    avatar: (state) => {
      return state.profile?.avatar || '/images/default-avatar.png'
    },

    // ç”¨æˆ·è§’è‰²
    roles: (state) => {
      return state.profile?.roles || []
    },

    // æ˜¯å¦ä¸ºç®¡ç†å‘˜
    isAdmin: (state) => {
      return state.profile?.roles.includes('admin') || false
    },

    // æ˜¯å¦ä¸ºè®²å¸ˆ
    isInstructor: (state) => {
      return state.profile?.roles.includes('instructor') || false
    },

    // æ£€æŸ¥æƒé™
    hasPermission: (state) => (permission: string) => {
      return state.permissions.some(p => p.name === permission)
    },

    // æ£€æŸ¥å¤šä¸ªæƒé™
    hasAnyPermission: (state) => (permissions: string[]) => {
      return permissions.some(permission => 
        state.permissions.some(p => p.name === permission)
      )
    },

    // æ£€æŸ¥æ‰€æœ‰æƒé™
    hasAllPermissions: (state) => (permissions: string[]) => {
      return permissions.every(permission => 
        state.permissions.some(p => p.name === permission)
      )
    },
  },

  actions: {
    // ç™»å½•
    async login(credentials: { email: string; password: string }) {
      return withAsyncState(this, async () => {
        const { data } = await $fetch<{
          user: User
          token: string
          refreshToken: string
          permissions: Permission[]
        }>('/api/auth/login', {
          method: 'POST',
          body: credentials,
        })

        this.profile = data.user
        this.token = data.token
        this.refreshToken = data.refreshToken
        this.permissions = data.permissions
        this.isAuthenticated = true

        // è®¾ç½®è¯·æ±‚å¤´
        this.setAuthHeader(data.token)

        return data
      })
    },

    // æ³¨å†Œ
    async register(userData: {
      email: string
      password: string
      firstName: string
      lastName: string
    }) {
      return withAsyncState(this, async () => {
        const { data } = await $fetch<{
          user: User
          token: string
          refreshToken: string
        }>('/api/auth/register', {
          method: 'POST',
          body: userData,
        })

        this.profile = data.user
        this.token = data.token
        this.refreshToken = data.refreshToken
        this.isAuthenticated = true

        this.setAuthHeader(data.token)

        return data
      })
    },

    // ç™»å‡º
    async logout() {
      return withAsyncState(this, async () => {
        if (this.token) {
          await $fetch('/api/auth/logout', {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${this.token}`,
            },
          })
        }

        this.$reset()
        this.clearAuthHeader()

        // é‡å®šå‘åˆ°ç™»å½•é¡µ
        await navigateTo('/login')
      })
    },

    // åˆ·æ–°ä»¤ç‰Œ
    async refreshAccessToken() {
      if (!this.refreshToken) {
        throw new Error('No refresh token available')
      }

      return withAsyncState(this, async () => {
        const { data } = await $fetch<{
          token: string
          refreshToken: string
        }>('/api/auth/refresh', {
          method: 'POST',
          body: {
            refreshToken: this.refreshToken,
          },
        })

        this.token = data.token
        this.refreshToken = data.refreshToken
        this.setAuthHeader(data.token)

        return data
      })
    },

    // è·å–ç”¨æˆ·ä¿¡æ¯
    async fetchProfile() {
      return withAsyncState(this, async () => {
        const { data } = await $fetch<{
          user: User
          permissions: Permission[]
        }>('/api/user/profile')

        this.profile = data.user
        this.permissions = data.permissions

        return data
      })
    },

    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    async updateProfile(updates: Partial<User>) {
      return withAsyncState(this, async () => {
        const { data } = await $fetch<{ user: User }>('/api/user/profile', {
          method: 'PUT',
          body: updates,
        })

        this.profile = data.user

        return data
      })
    },

    // æ›´æ–°åå¥½è®¾ç½®
    async updatePreferences(preferences: Partial<UserPreferences>) {
      return withAsyncState(this, async () => {
        const { data } = await $fetch<{ preferences: UserPreferences }>(
          '/api/user/preferences',
          {
            method: 'PUT',
            body: preferences,
          }
        )

        this.preferences = data.preferences

        return data
      })
    },

    // ä¿®æ”¹å¯†ç 
    async changePassword(passwordData: {
      currentPassword: string
      newPassword: string
    }) {
      return withAsyncState(this, async () => {
        await $fetch('/api/user/password', {
          method: 'PUT',
          body: passwordData,
        })

        return { success: true }
      })
    },

    // ä¸Šä¼ å¤´åƒ
    async uploadAvatar(file: File) {
      return withAsyncState(this, async () => {
        const formData = new FormData()
        formData.append('avatar', file)

        const { data } = await $fetch<{ avatarUrl: string }>(
          '/api/user/avatar',
          {
            method: 'POST',
            body: formData,
          }
        )

        if (this.profile) {
          this.profile.avatar = data.avatarUrl
        }

        return data
      })
    },

    // è®¾ç½®è®¤è¯å¤´
    setAuthHeader(token: string) {
      // è¿™é‡Œå¯ä»¥è®¾ç½®å…¨å±€çš„è¯·æ±‚å¤´
      // æˆ–è€…ä½¿ç”¨ Nuxt çš„ $fetch é…ç½®
    },

    // æ¸…é™¤è®¤è¯å¤´
    clearAuthHeader() {
      // æ¸…é™¤å…¨å±€è¯·æ±‚å¤´
    },

    // æ£€æŸ¥è®¤è¯çŠ¶æ€
    async checkAuth() {
      if (!this.token) {
        this.isAuthenticated = false
        return false
      }

      try {
        await this.fetchProfile()
        this.isAuthenticated = true
        return true
      } catch (error) {
        this.isAuthenticated = false
        this.$reset()
        return false
      }
    },
  },

  persist: {
    key: 'user-store',
    storage: localStorage,
    paths: ['profile', 'preferences', 'token', 'refreshToken', 'isAuthenticated'],
  },
})

// å¯¼å‡ºä¾¿æ·çš„ç»„åˆå¼å‡½æ•°
export const useAuth = () => {
  const store = useUserStore()

  return {
    // çŠ¶æ€
    user: readonly(toRef(store, 'profile')),
    preferences: readonly(toRef(store, 'preferences')),
    permissions: readonly(toRef(store, 'permissions')),
    isAuthenticated: readonly(toRef(store, 'isAuthenticated')),
    isLoading: readonly(toRef(store, 'loading')),
    error: readonly(toRef(store, 'error')),

    // è®¡ç®—å±æ€§
    fullName: computed(() => store.fullName),
    avatar: computed(() => store.avatar),
    roles: computed(() => store.roles),
    isAdmin: computed(() => store.isAdmin),
    isInstructor: computed(() => store.isInstructor),

    // æ–¹æ³•
    login: store.login,
    register: store.register,
    logout: store.logout,
    updateProfile: store.updateProfile,
    updatePreferences: store.updatePreferences,
    changePassword: store.changePassword,
    uploadAvatar: store.uploadAvatar,
    hasPermission: store.hasPermission,
    hasAnyPermission: store.hasAnyPermission,
    hasAllPermissions: store.hasAllPermissions,
    checkAuth: store.checkAuth,
  }
}
```

## ğŸ¨ åº”ç”¨çŠ¶æ€ç®¡ç†

### åº”ç”¨ Store

```typescript
// stores/app.ts
import { defineStore } from 'pinia'

interface Notification {
  id: string
  type: 'info' | 'success' | 'warning' | 'error'
  title: string
  message: string
  duration?: number
  persistent?: boolean
  actions?: Array<{
    label: string
    action: () => void
  }>
  createdAt: number
}

interface AppState {
  // ä¸»é¢˜è®¾ç½®
  theme: 'light' | 'dark' | 'system'
  
  // è¯­è¨€è®¾ç½®
  language: string
  
  // ä¾§è¾¹æ çŠ¶æ€
  sidebar: {
    collapsed: boolean
    width: number
    mobile: boolean
  }
  
  // é€šçŸ¥ç³»ç»Ÿ
  notifications: Notification[]
  
  // å…¨å±€åŠ è½½çŠ¶æ€
  globalLoading: boolean
  
  // ç½‘ç»œçŠ¶æ€
  online: boolean
  
  // é¡µé¢å…ƒæ•°æ®
  pageTitle: string
  breadcrumbs: Array<{
    label: string
    to?: string
  }>
  
  // æ¨¡æ€æ¡†çŠ¶æ€
  modals: Record<string, boolean>
  
  // å…¨å±€è®¾ç½®
  settings: {
    autoSave: boolean
    autoSaveInterval: number
    showTutorial: boolean
    enableAnimations: boolean
    enableSounds: boolean
  }
}

export const useAppStore = defineStore('app', {
  state: (): AppState => ({
    theme: 'system',
    language: 'zh-CN',
    sidebar: {
      collapsed: false,
      width: 280,
      mobile: false,
    },
    notifications: [],
    globalLoading: false,
    online: navigator.onLine,
    pageTitle: '',
    breadcrumbs: [],
    modals: {},
    settings: {
      autoSave: true,
      autoSaveInterval: 30000,
      showTutorial: true,
      enableAnimations: true,
      enableSounds: false,
    },
  }),

  getters: {
    // å½“å‰ä¸»é¢˜
    currentTheme: (state) => {
      if (state.theme === 'system') {
        return window.matchMedia('(prefers-color-scheme: dark)').matches
          ? 'dark'
          : 'light'
      }
      return state.theme
    },

    // æœªè¯»é€šçŸ¥æ•°é‡
    unreadNotificationsCount: (state) => {
      return state.notifications.length
    },

    // é”™è¯¯é€šçŸ¥
    errorNotifications: (state) => {
      return state.notifications.filter(n => n.type === 'error')
    },

    // æ˜¯å¦æ˜¾ç¤ºä¾§è¾¹æ 
    shouldShowSidebar: (state) => {
      return !state.sidebar.mobile || !state.sidebar.collapsed
    },

    // å†…å®¹åŒºåŸŸæ ·å¼
    contentStyles: (state) => {
      const sidebarWidth = state.sidebar.collapsed ? 64 : state.sidebar.width
      return {
        marginLeft: state.sidebar.mobile ? 0 : `${sidebarWidth}px`,
        transition: 'margin-left 0.3s ease',
      }
    },
  },

  actions: {
    // è®¾ç½®ä¸»é¢˜
    setTheme(theme: 'light' | 'dark' | 'system') {
      this.theme = theme
      this.applyTheme()
    },

    // åº”ç”¨ä¸»é¢˜
    applyTheme() {
      const theme = this.currentTheme
      document.documentElement.classList.toggle('dark', theme === 'dark')
      document.documentElement.setAttribute('data-theme', theme)
    },

    // åˆ‡æ¢ä¸»é¢˜
    toggleTheme() {
      const themes: Array<'light' | 'dark' | 'system'> = ['light', 'dark', 'system']
      const currentIndex = themes.indexOf(this.theme)
      const nextIndex = (currentIndex + 1) % themes.length
      this.setTheme(themes[nextIndex])
    },

    // è®¾ç½®è¯­è¨€
    setLanguage(language: string) {
      this.language = language
      // è¿™é‡Œå¯ä»¥é›†æˆ i18n
    },

    // åˆ‡æ¢ä¾§è¾¹æ 
    toggleSidebar() {
      this.sidebar.collapsed = !this.sidebar.collapsed
    },

    // è®¾ç½®ä¾§è¾¹æ çŠ¶æ€
    setSidebarCollapsed(collapsed: boolean) {
      this.sidebar.collapsed = collapsed
    },

    // è®¾ç½®ä¾§è¾¹æ å®½åº¦
    setSidebarWidth(width: number) {
      this.sidebar.width = Math.max(200, Math.min(400, width))
    },

    // è®¾ç½®ç§»åŠ¨ç«¯æ¨¡å¼
    setMobileMode(mobile: boolean) {
      this.sidebar.mobile = mobile
      if (mobile) {
        this.sidebar.collapsed = true
      }
    },

    // æ·»åŠ é€šçŸ¥
    addNotification(notification: Omit<Notification, 'id' | 'createdAt'>) {
      const id = `notification-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
      const newNotification: Notification = {
        ...notification,
        id,
        createdAt: Date.now(),
      }

      this.notifications.unshift(newNotification)

      // è‡ªåŠ¨ç§»é™¤é€šçŸ¥
      if (!notification.persistent && notification.duration !== 0) {
        const duration = notification.duration || 5000
        setTimeout(() => {
          this.removeNotification(id)
        }, duration)
      }

      return id
    },

    // ç§»é™¤é€šçŸ¥
    removeNotification(id: string) {
      const index = this.notifications.findIndex(n => n.id === id)
      if (index > -1) {
        this.notifications.splice(index, 1)
      }
    },

    // æ¸…é™¤æ‰€æœ‰é€šçŸ¥
    clearNotifications() {
      this.notifications = []
    },

    // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
    showSuccess(title: string, message?: string) {
      return this.addNotification({
        type: 'success',
        title,
        message: message || '',
      })
    },

    // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥
    showError(title: string, message?: string) {
      return this.addNotification({
        type: 'error',
        title,
        message: message || '',
        persistent: true,
      })
    },

    // æ˜¾ç¤ºè­¦å‘Šé€šçŸ¥
    showWarning(title: string, message?: string) {
      return this.addNotification({
        type: 'warning',
        title,
        message: message || '',
      })
    },

    // æ˜¾ç¤ºä¿¡æ¯é€šçŸ¥
    showInfo(title: string, message?: string) {
      return this.addNotification({
        type: 'info',
        title,
        message: message || '',
      })
    },

    // è®¾ç½®å…¨å±€åŠ è½½çŠ¶æ€
    setGlobalLoading(loading: boolean) {
      this.globalLoading = loading
    },

    // è®¾ç½®ç½‘ç»œçŠ¶æ€
    setOnlineStatus(online: boolean) {
      this.online = online
      
      if (!online) {
        this.showWarning('ç½‘ç»œè¿æ¥æ–­å¼€', 'è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥')
      } else {
        this.showSuccess('ç½‘ç»œè¿æ¥å·²æ¢å¤')
      }
    },

    // è®¾ç½®é¡µé¢æ ‡é¢˜
    setPageTitle(title: string) {
      this.pageTitle = title
      document.title = title ? `${title} - å­¦ä¹ ç®¡ç†ç³»ç»Ÿ` : 'å­¦ä¹ ç®¡ç†ç³»ç»Ÿ'
    },

    // è®¾ç½®é¢åŒ…å±‘
    setBreadcrumbs(breadcrumbs: AppState['breadcrumbs']) {
      this.breadcrumbs = breadcrumbs
    },

    // æ‰“å¼€æ¨¡æ€æ¡†
    openModal(modalId: string) {
      this.modals[modalId] = true
    },

    // å…³é—­æ¨¡æ€æ¡†
    closeModal(modalId: string) {
      this.modals[modalId] = false
    },

    // åˆ‡æ¢æ¨¡æ€æ¡†
    toggleModal(modalId: string) {
      this.modals[modalId] = !this.modals[modalId]
    },

    // æ›´æ–°è®¾ç½®
    updateSettings(settings: Partial<AppState['settings']>) {
      this.settings = { ...this.settings, ...settings }
    },

    // åˆå§‹åŒ–åº”ç”¨
    async initializeApp() {
      // åº”ç”¨ä¸»é¢˜
      this.applyTheme()

      // ç›‘å¬ç½‘ç»œçŠ¶æ€
      window.addEventListener('online', () => this.setOnlineStatus(true))
      window.addEventListener('offline', () => this.setOnlineStatus(false))

      // ç›‘å¬ä¸»é¢˜å˜åŒ–
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')
      mediaQuery.addEventListener('change', () => {
        if (this.theme === 'system') {
          this.applyTheme()
        }
      })

      // ç›‘å¬çª—å£å¤§å°å˜åŒ–
      const handleResize = () => {
        this.setMobileMode(window.innerWidth < 768)
      }
      window.addEventListener('resize', handleResize)
      handleResize()
    },
  },

  persist: {
    key: 'app-store',
    storage: localStorage,
    paths: ['theme', 'language', 'sidebar', 'settings'],
  },
})

// å¯¼å‡ºä¾¿æ·çš„ç»„åˆå¼å‡½æ•°
export const useApp = () => {
  const store = useAppStore()

  return {
    // çŠ¶æ€
    theme: readonly(toRef(store, 'theme')),
    language: readonly(toRef(store, 'language')),
    sidebar: readonly(toRef(store, 'sidebar')),
    notifications: readonly(toRef(store, 'notifications')),
    globalLoading: readonly(toRef(store, 'globalLoading')),
    online: readonly(toRef(store, 'online')),
    pageTitle: readonly(toRef(store, 'pageTitle')),
    breadcrumbs: readonly(toRef(store, 'breadcrumbs')),
    settings: readonly(toRef(store, 'settings')),

    // è®¡ç®—å±æ€§
    currentTheme: computed(() => store.currentTheme),
    unreadNotificationsCount: computed(() => store.unreadNotificationsCount),
    shouldShowSidebar: computed(() => store.shouldShowSidebar),
    contentStyles: computed(() => store.contentStyles),

    // æ–¹æ³•
    setTheme: store.setTheme,
    toggleTheme: store.toggleTheme,
    setLanguage: store.setLanguage,
    toggleSidebar: store.toggleSidebar,
    setSidebarCollapsed: store.setSidebarCollapsed,
    addNotification: store.addNotification,
    removeNotification: store.removeNotification,
    clearNotifications: store.clearNotifications,
    showSuccess: store.showSuccess,
    showError: store.showError,
    showWarning: store.showWarning,
    showInfo: store.showInfo,
    setPageTitle: store.setPageTitle,
    setBreadcrumbs: store.setBreadcrumbs,
    openModal: store.openModal,
    closeModal: store.closeModal,
    toggleModal: store.toggleModal,
    updateSettings: store.updateSettings,
  }
}
```

## ğŸ”„ çŠ¶æ€åŒæ­¥ä¸æŒä¹…åŒ–

### é«˜çº§æŒä¹…åŒ–é…ç½®

```typescript
// plugins/pinia-persistence.ts
import { PiniaPluginContext } from 'pinia'
import { watch } from 'vue'

// è‡ªå®šä¹‰æŒä¹…åŒ–æ’ä»¶
export function createAdvancedPersistence() {
  return ({ store, options }: PiniaPluginContext) => {
    // è·å–æŒä¹…åŒ–é…ç½®
    const persistConfig = options.persist

    if (!persistConfig) return

    const {
      key = store.$id,
      storage = localStorage,
      paths,
      beforeRestore,
      afterRestore,
      serializer = {
        serialize: JSON.stringify,
        deserialize: JSON.parse,
      },
    } = typeof persistConfig === 'object' ? persistConfig : {}

    // æ¢å¤çŠ¶æ€
    const restore = () => {
      try {
        const stored = storage.getItem(key)
        if (!stored) return

        beforeRestore?.(store)

        const data = serializer.deserialize(stored)
        
        if (paths) {
          // åªæ¢å¤æŒ‡å®šè·¯å¾„çš„çŠ¶æ€
          paths.forEach(path => {
            if (data[path] !== undefined) {
              store.$patch({ [path]: data[path] })
            }
          })
        } else {
          // æ¢å¤æ‰€æœ‰çŠ¶æ€
          store.$patch(data)
        }

        afterRestore?.(store)
      } catch (error) {
        console.error(`Failed to restore store ${store.$id}:`, error)
      }
    }

    // ä¿å­˜çŠ¶æ€
    const persist = () => {
      try {
        const data = paths
          ? paths.reduce((acc, path) => {
              acc[path] = store[path]
              return acc
            }, {} as any)
          : store.$state

        storage.setItem(key, serializer.serialize(data))
      } catch (error) {
        console.error(`Failed to persist store ${store.$id}:`, error)
      }
    }

    // åˆå§‹æ¢å¤
    restore()

    // ç›‘å¬çŠ¶æ€å˜åŒ–å¹¶æŒä¹…åŒ–
    store.$subscribe(
      (mutation, state) => {
        persist()
      },
      { detached: true }
    )
  }
}

// çŠ¶æ€åŒæ­¥æ’ä»¶
export function createStateSyncPlugin() {
  return ({ store }: PiniaPluginContext) => {
    // è·¨æ ‡ç­¾é¡µçŠ¶æ€åŒæ­¥
    if (typeof window !== 'undefined') {
      window.addEventListener('storage', (e) => {
        if (e.key === store.$id && e.newValue) {
          try {
            const newState = JSON.parse(e.newValue)
            store.$patch(newState)
          } catch (error) {
            console.error('Failed to sync state:', error)
          }
        }
      })
    }

    // æ·»åŠ çŠ¶æ€åŒæ­¥æ–¹æ³•
    store.syncState = (targetStore: any) => {
      watch(
        () => store.$state,
        (newState) => {
          targetStore.$patch(newState)
        },
        { deep: true }
      )
    }
  }
}
```

### çŠ¶æ€è¿ç§»ç³»ç»Ÿ

```typescript
// utils/state-migration.ts
interface MigrationConfig {
  version: number
  migrations: Record<number, (state: any) => any>
}

export class StateMigration {
  private config: MigrationConfig

  constructor(config: MigrationConfig) {
    this.config = config
  }

  // è¿ç§»çŠ¶æ€
  migrate(state: any): any {
    const currentVersion = state._version || 0
    const targetVersion = this.config.version

    if (currentVersion >= targetVersion) {
      return state
    }

    let migratedState = { ...state }

    // é€æ­¥æ‰§è¡Œè¿ç§»
    for (let version = currentVersion + 1; version <= targetVersion; version++) {
      const migration = this.config.migrations[version]
      if (migration) {
        migratedState = migration(migratedState)
      }
    }

    // æ›´æ–°ç‰ˆæœ¬å·
    migratedState._version = targetVersion

    return migratedState
  }

  // æ£€æŸ¥æ˜¯å¦éœ€è¦è¿ç§»
  needsMigration(state: any): boolean {
    const currentVersion = state._version || 0
    return currentVersion < this.config.version
  }
}

// ç”¨æˆ·çŠ¶æ€è¿ç§»é…ç½®
export const userStateMigration = new StateMigration({
  version: 3,
  migrations: {
    1: (state) => ({
      ...state,
      preferences: {
        ...state.preferences,
        theme: state.theme || 'system', // è¿ç§»æ—§çš„ä¸»é¢˜è®¾ç½®
      },
    }),
    2: (state) => ({
      ...state,
      permissions: state.permissions || [], // æ·»åŠ æƒé™å­—æ®µ
    }),
    3: (state) => ({
      ...state,
      preferences: {
        ...state.preferences,
        notifications: {
          email: true,
          push: true,
          sms: false,
          ...state.preferences.notifications,
        },
      },
    }),
  },
})
```

## ğŸ§ª å®è·µç»ƒä¹ 

1. **å®ç°çŠ¶æ€æ—¶é—´æ—…è¡Œè°ƒè¯•**
   - è®°å½•çŠ¶æ€å˜åŒ–å†å²
   - å®ç°æ’¤é”€/é‡åšåŠŸèƒ½
   - æ·»åŠ çŠ¶æ€å¿«ç…§åŠŸèƒ½

2. **æ„å»ºå®æ—¶çŠ¶æ€åŒæ­¥**
   - WebSocket çŠ¶æ€åŒæ­¥
   - å†²çªè§£å†³æœºåˆ¶
   - ç¦»çº¿çŠ¶æ€å¤„ç†

3. **ä¼˜åŒ–çŠ¶æ€ç®¡ç†æ€§èƒ½**
   - çŠ¶æ€åˆ†ç‰‡å’Œæ‡’åŠ è½½
   - è®¡ç®—å±æ€§ç¼“å­˜ä¼˜åŒ–
   - å¤§æ•°æ®é›†å¤„ç†ç­–ç•¥

## ğŸ’­ æ€è€ƒé¢˜

1. **å¦‚ä½•è®¾è®¡ä¸€ä¸ªå¯æ‰©å±•çš„çŠ¶æ€ç®¡ç†æ¶æ„ï¼Ÿ**
   - æ¨¡å—åŒ–è®¾è®¡åŸåˆ™
   - çŠ¶æ€ä¾èµ–å…³ç³»ç®¡ç†
   - æ’ä»¶ç³»ç»Ÿè®¾è®¡

2. **çŠ¶æ€æŒä¹…åŒ–çš„å®‰å…¨æ€§å¦‚ä½•ä¿éšœï¼Ÿ**
   - æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
   - çŠ¶æ€å®Œæ•´æ€§éªŒè¯
   - è·¨åŸŸå®‰å…¨è€ƒè™‘

3. **å¦‚ä½•å¤„ç†å¤æ‚çš„çŠ¶æ€åŒæ­¥åœºæ™¯ï¼Ÿ**
   - å¤šç”¨æˆ·åä½œçŠ¶æ€
   - å®æ—¶æ•°æ®æ›´æ–°
   - ç½‘ç»œå¼‚å¸¸å¤„ç†

## ğŸ‰ å°ç»“

é€šè¿‡è¿™ä¸€ç« çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„çŠ¶æ€ç®¡ç†ç³»ç»Ÿã€‚ä»åŸºç¡€æ¦‚å¿µåˆ°é«˜çº§æ¨¡å¼ï¼Œä»å•ä¸€ Store åˆ°å¤æ‚çš„çŠ¶æ€ç”Ÿæ€ç³»ç»Ÿï¼Œæˆ‘ä»¬æŒæ¡äº†ç°ä»£å‰ç«¯åº”ç”¨çŠ¶æ€ç®¡ç†çš„æ ¸å¿ƒæŠ€èƒ½ã€‚

æˆ‘ä»¬å­¦åˆ°äº†ï¼š
- âœ… Pinia çš„é«˜çº§ç”¨æ³•å’Œæœ€ä½³å®è·µ
- âœ… æ¨¡å—åŒ–çŠ¶æ€ç®¡ç†æ¶æ„è®¾è®¡
- âœ… çŠ¶æ€æŒä¹…åŒ–å’ŒåŒæ­¥æœºåˆ¶
- âœ… å“åº”å¼æ•°æ®æµç³»ç»Ÿæ„å»º
- âœ… æ€§èƒ½ä¼˜åŒ–å’Œå¼€å‘ä½“éªŒæå‡

ä¸€ä¸ªä¼˜ç§€çš„çŠ¶æ€ç®¡ç†ç³»ç»Ÿå°±åƒæ˜¯åº”ç”¨çš„ç¥ç»ç³»ç»Ÿï¼Œå®ƒè¿æ¥ç€å„ä¸ªç»„ä»¶ï¼Œåè°ƒç€æ•°æ®çš„æµåŠ¨ï¼Œç¡®ä¿åº”ç”¨çš„ç¨³å®šè¿è¡Œã€‚åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢ API é›†æˆä¸æ•°æ®è·å–çš„é«˜çº§æŠ€å·§ï¼Œå­¦ä¹ å¦‚ä½•æ„å»ºé«˜æ•ˆã€å¯é çš„æ•°æ®å±‚ã€‚

---

**ä¸‹ä¸€ç« é¢„å‘Šï¼š** ã€ŠAPI é›†æˆä¸æ•°æ®è·å–ã€‹- æˆ‘ä»¬å°†æ·±å…¥å­¦ä¹ ç°ä»£ API é›†æˆæ¨¡å¼ï¼ŒåŒ…æ‹¬ RESTful APIã€GraphQLã€å®æ—¶é€šä¿¡ã€é”™è¯¯å¤„ç†ã€ç¼“å­˜ç­–ç•¥ç­‰æ ¸å¿ƒæŠ€æœ¯ã€‚